# 📺 Plan: Video Series System & Bug Fixes

## 🎯 Цели
1. Исправить баги (статистика видео, картинки)
2. Добавить систему сериалов с сезонами
3. Массовая загрузка с автопарсингом имён файлов
4. Drag & Drop сортировка серий
5. React Native интеграция

---

## 📊 Текущая проблема: Статистика видео = 0

### Диагноз
Счётчик `totalVideos` в API не возвращается или не считается правильно.

### Решение
- [ ] Проверить `GetStats()` в `multimedia_service.go` — должен считать `WHERE media_type = 'video'`
- [ ] Проверить фронтенд `stats?.totalVideos` — правильно ли читает?
- [ ] Добавить поле в ответ API если отсутствует

---

## 🖼️ Карточки видео с картинками

### Текущее состояние
Карточки показывают только текст (название, артист). Нет превью.

### Решение
- [ ] Использовать поле `coverImageURL` из модели `MediaTrack`
- [ ] Если нет обложки — показать placeholder или первый кадр видео
- [ ] Обновить `TracksTable` для отображения миниатюры

---

## 🎬 Система сериалов

### Новые сущности (модели)

```
Series (Сериал)
├── ID
├── title (название)
├── description (описание)
├── coverImageURL (обложка)
├── year (год выпуска)
├── genre (жанр)
├── isActive
├── sortOrder
└── Seasons[] (связь 1:N)

Season (Сезон)
├── ID
├── seriesID (FK → Series)
├── number (номер сезона: 1, 2, 3...)
├── title (опционально: "Сезон 1 - Начало")
├── sortOrder
└── Episodes[] (связь 1:N)

Episode (Серия/Эпизод)
├── ID
├── seasonID (FK → Season)
├── number (номер серии: 1, 2, 3...)
├── title (название серии)
├── description
├── videoURL (ссылка на видео в S3)
├── thumbnailURL (превью)
├── duration (длительность)
├── sortOrder
└── isActive
```

### Связи
```
Series 1:N Season 1:N Episode
```

---

## 📤 Массовая загрузка

### Алгоритм
1. Пользователь выбирает несколько файлов (или архив)
2. Система парсит имена файлов:
   - `s01e01.mp4` → Сезон 1, Эпизод 1
   - `s01e02_Название.mp4` → Сезон 1, Эпизод 2, название "Название"
   - `Mahabharata_S01E01.mp4` → Сезон 1, Эпизод 1
3. Показывает превью (таблица: файл → сезон → эпизод → название)
4. Пользователь может редактировать перед подтверждением
5. Загрузка через presigned URL (как уже работает)

### Регулярка для парсинга
```regex
[Ss]?(\d{1,2})[Ee](\d{1,3})
```
Примеры:
- `S01E01` → season=1, episode=1
- `s1e10` → season=1, episode=10
- `01x05` → season=1, episode=5

---

## 🔀 Drag & Drop сортировка

### Реализация
- Использовать `@dnd-kit/core` (React) для Admin Panel
- При изменении порядка → PATCH `/api/admin/series/{id}/reorder`
- Сохранять `sortOrder` для каждого эпизода

---

## 📱 React Native (Фронтенд)

### Экран "Фильмы и Сериалы"
```
[Фильмы] [Сериалы] ← переключатель/табы

Сериалы:
┌─────────────────────────┐
│ 🖼️ Obложка              │
│ Махабхарата             │
│ 2 сезона • 2024         │
└─────────────────────────┘
```

### Экран сериала (при клике)
```
┌─────────────────────────┐
│ 🖼️ Большая обложка      │
│ Махабхарата             │
│ Описание...             │
├─────────────────────────┤
│ Сезон 1 ▼               │
│ ┌───┬─────────────────┐ │
│ │ 1 │ Рождение героев │ │
│ │ 2 │ Изгнание        │ │
│ │ 3 │ Лесная жизнь    │ │
│ └───┴─────────────────┘ │
├─────────────────────────┤
│ Сезон 2 ▼               │
│ ...                     │
└─────────────────────────┘
```

---

## 🗂️ Разбивка задач

### Phase 1: Bug Fixes (1-2 часа)
| # | Задача | Файл | Агент |
|---|--------|------|-------|
| 1.1 | Исправить счётчик видео в статистике | `multimedia_service.go` | backend |
| 1.2 | Добавить картинки в TracksTable | `page.tsx` | frontend |

### Phase 2: Database Models (2-3 часа)
| # | Задача | Файл | Агент |
|---|--------|------|-------|
| 2.1 | Создать модели Series, Season, Episode | `models/series.go` | backend |
| 2.2 | Миграция базы данных | `database/migrate.go` | backend |

### Phase 3: Backend API (3-4 часа)
| # | Задача | Файл | Агент |
|---|--------|------|-------|
| 3.1 | CRUD для Series | `handlers/series_handler.go` | backend |
| 3.2 | CRUD для Seasons | (в том же файле) | backend |
| 3.3 | CRUD для Episodes | (в том же файле) | backend |
| 3.4 | Массовая загрузка эпизодов | `handlers/series_handler.go` | backend |
| 3.5 | Reorder эпизодов (drag & drop) | `handlers/series_handler.go` | backend |

### Phase 4: Admin Panel (4-5 часов)
| # | Задача | Файл | Агент |
|---|--------|------|-------|
| 4.1 | Вкладка "Series" в Multimedia | `multimedia/page.tsx` | frontend |
| 4.2 | Форма создания сериала | (компонент) | frontend |
| 4.3 | Управление сезонами | (компонент) | frontend |
| 4.4 | Массовая загрузка с парсингом | (компонент) | frontend |
| 4.5 | Drag & Drop сортировка | (dnd-kit) | frontend |

### Phase 5: React Native (3-4 часа)
| # | Задача | Файл | Агент |
|---|--------|------|-------|
| 5.1 | Экран списка сериалов | `SeriesListScreen.tsx` | mobile |
| 5.2 | Экран сериала (сезоны + эпизоды) | `SeriesDetailScreen.tsx` | mobile |
| 5.3 | Интеграция с видеоплеером | (существующий) | mobile |

### Phase 6: Testing & Deploy (1-2 часа)
| # | Задача |
|---|--------|
| 6.1 | Тест загрузки большого сериала (10+ серий) |
| 6.2 | Тест воспроизведения на мобильном |
| 6.3 | Deploy backend + admin + mobile |

---

## ⏱️ Оценка времени

| Phase | Время |
|-------|-------|
| Phase 1: Bug Fixes | 1-2 ч |
| Phase 2: Models | 2-3 ч |
| Phase 3: Backend API | 3-4 ч |
| Phase 4: Admin Panel | 4-5 ч |
| Phase 5: React Native | 3-4 ч |
| Phase 6: Testing | 1-2 ч |
| **Итого** | **14-20 часов** |

---

## ✅ Критерии готовности

- [ ] Статистика видео показывает правильное число
- [ ] Карточки видео имеют превью-картинку
- [ ] Можно создать сериал с сезонами и эпизодами
- [ ] Массовая загрузка парсит `S01E01` формат
- [ ] Можно менять порядок эпизодов drag & drop
- [ ] В React Native виден список сериалов
- [ ] Можно открыть сериал и выбрать эпизод для просмотра

---

## 🚀 Рекомендация по порядку

**Шаг 1:** Сначала исправить баги (Phase 1) — это быстро и даст результат.

**Шаг 2:** Потом делать сериалы (Phase 2-5) последовательно.

Начать с Phase 1?
