# План реализации: Единый Гео-Сервис (Map Service)

## Фаза 1: Инфраструктура и Бэкенд (Go)
Подготовка базы данных и создание API для агрегации гео-данных.

- [x] Task: Настроить поддержку гео-запросов в БД и добавить индексы для координат в таблицах `users`, `shops`, `ads`. ✅ (Используются существующие поля latitude/longitude)
- [x] Task: Реализовать базовый Handler в Go для Geoapify Proxy (Tiles & Routing). ✅ (`map_handler.go` - GetRoute, GetTileConfig)
- [ ] Task: Написать тесты для сервиса агрегации гео-данных.
- [x] Task: Реализовать эндпоинт `GET /api/map/markers` с поддержкой фильтрации по Bounding Box и категориям. ✅
- [x] Task: Реализовать логику кластеризации на стороне сервера для мелких масштабов (`GET /api/map/summary`). ✅
- [ ] Task: Conductor - User Manual Verification 'Фаза 1: Инфраструктура и Бэкенд' (Protocol in workflow.md)

## Фаза 2: Базовая карта и Маркеры (React Native)
Интеграция карты в мобильное приложение и отображение данных.

- [x] Task: Установить и настроить `react-native-maps` и компоненты для работы с Geoapify Tiles. ✅ (Добавлено в package.json)
- [x] Task: Реализовать экран `MapGeoapifyScreen.tsx` с базовым слоем карты. ✅
- [ ] Task: Написать тесты для рендеринга кастомных маркеров и системы фильтрации.
- [x] Task: Реализовать отображение маркеров (Пользователи, Магазины, Объявления) с использованием кластеризации. ✅
- [x] Task: Создать UI для управления слоями (Floating Action Buttons). ✅ (Filter chips в MapGeoapifyScreen)
- [ ] Task: Conductor - User Manual Verification 'Фаза 2: Базовая карта и Маркеры' (Protocol in workflow.md)

## Фаза 3: Взаимодействие и Навигация
Реализация детальных карточек и построения маршрутов.

- [x] Task: Интегрировать `gorhom/bottom-sheet` для отображения информации об объекте при клике на маркер. ✅ (Используется infoCard в MapGeoapifyScreen, добавлено в package.json)
- [x] Task: Реализовать поиск по названию объектов с автодополнением (Geoapify Autocomplete). ✅ (Бэкенд endpoint + mapService.autocomplete)
- [ ] Task: Написать тесты для логики построения маршрутов.
- [x] Task: Реализовать визуализацию маршрута на карте с использованием Geoapify Routing API. ✅ (Polyline в MapGeoapifyScreen)
- [x] Task: Добавить Deep Linking: переход из карточки объекта в соответствующие разделы (Чат, Магазин, Объявление). ✅ (Кнопка "Подробнее" в infoCard)
- [ ] Task: Conductor - User Manual Verification 'Фаза 3: Взаимодействие и Навигация' (Protocol in workflow.md)

## Фаза 4: Интеграция с AI-Ассистентом
Связь чата с картой для интеллектуального поиска.

- [x] Task: Расширить логику AI-бэкенда (Go) для распознавания гео-интентов (например, "найди", "где"). ✅ (`geo_intent_service.go`)
- [x] Task: Реализовать формат ответа AI с метаданными для отображения на карте. ✅ (`FormatMapResponse` + `mapData` в Message)
- [ ] Task: Написать интеграционные тесты для связки AI -> Map.
- [x] Task: Добавить в интерфейс чата кнопку "Показать на карте" для результатов поиска ассистента. ✅ (`MessageList.tsx` + `MapPin` button)
- [x] Task: Реализовать автоматическое применение фильтров карты при переходе из чата. ✅ (`onNavigateToMap` в ChatScreen)
- [ ] Task: Conductor - User Manual Verification 'Фаза 4: Интеграция с AI-Ассистентом' (Protocol in workflow.md)

## Фаза 5: Админ-панель (Next.js)
Интеграция управления картой в административный интерфейс.

- [x] Task: Создать страницу "Map Management" в админ-панели. ✅ (`admin/src/app/map/page.tsx` - стата, фильтры, таблица)
- [x] Task: Реализовать отображение карты с полным доступом ко всем слоям (режим администратора). ✅ (Backend API `/admin/map/markers` добавлен)
- [ ] Task: Написать тесты для компонентов админ-панели.
- [x] Task: Реализовать функционал модерации (скрытие/блокировка маркеров). ✅ (Добавлена кнопка Toggle Visibility в таблицу)
- [x] Task: Добавить форму настройки категорий (иконки, цвета) и статуса сервиса. ✅ (Добавлен UI и API для сохранения конфига в БД)
- [ ] Task: Conductor - User Manual Verification 'Фаза 5: Админ-панель' (Protocol in workflow.md)

## Фаза 6: Оптимизация и Финализация
Полировка UI/UX и проверка производительности.

- [ ] Task: Оптимизировать производительность карты (мемоизация маркеров, предотвращение лишних рендеров).
- [ ] Task: Стилизовать карту под общую тему приложения (Vedic Design System).
- [ ] Task: Провести финальное тестирование всех сценариев на Android и iOS.
- [ ] Task: Conductor - User Manual Verification 'Фаза 5: Оптимизация и Финализация' (Protocol in workflow.md)
