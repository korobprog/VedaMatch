# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Rag Agent

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

Rag Agent - —ç—Ç–æ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React Native) —Å –±–µ–∫–µ–Ω–¥–æ–º –Ω–∞ Go, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —á–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å AI –º–æ–¥–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π API, –∞ —Ç–∞–∫–∂–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π RAG (Retrieval-Augmented Generation) –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  React Native   ‚îÇ  Frontend (Android/iOS)
‚îÇ     App         ‚îÇ  –ü–æ—Ä—Ç: 8082 (Metro)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTP
         ‚îÇ http://10.0.2.2:8081/api/v1/chat/completions
         ‚îÇ (Android Emulator ‚Üí localhost:8081)
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Go Backend    ‚îÇ  Fiber Framework
‚îÇ   Port: 8081    ‚îÇ  /api/v1/chat/completions
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTP Proxy
         ‚îÇ https://rvlautoai.ru/webhook/v1/chat/completions
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  External API   ‚îÇ  RVFreeLLM API
‚îÇ  rvlautoai.ru   ‚îÇ  –ú–Ω–æ–∂–µ—Å—Ç–≤–æ AI –º–æ–¥–µ–ª–µ–π
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL     ‚îÇ  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   Port: 5435    ‚îÇ  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Google Gemini  ‚îÇ  RAG —Å–∏—Å—Ç–µ–º–∞
‚îÇ   RAG Store     ‚îÇ  –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Timeweb Cloud  ‚îÇ  S3 Storage (–ú–µ–¥–∏–∞)
‚îÇ   S3 (ru-1)     ‚îÇ  –ê–≤–∞—Ç–∞—Ä—ã, —Ñ–æ—Ç–æ, —Ñ–∞–π–ª—ã
‚îÇ  (S3 protocol)  ‚îÇ  Signature v4 auth
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Frontend (React Native)

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Framework**: React Native 0.76.5
- **Language**: TypeScript
- **Metro Port**: 8082
- **Package Manager**: pnpm

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
frontend/
‚îú‚îÄ‚îÄ App.tsx                    # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —á–∞—Ç–æ–º
‚îú‚îÄ‚îÄ RegistrationScreen.tsx     # –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ SettingsDrawer.tsx         # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–æ–¥–µ–ª–∏, –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)
‚îú‚îÄ‚îÄ ChatImage.tsx              # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —á–∞—Ç–µ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ chat/
‚îÇ       ‚îú‚îÄ‚îÄ MessageList.tsx    # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (Text, Audio, Image, Doc)
‚îÇ       ‚îî‚îÄ‚îÄ AudioPlayer.tsx    # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ openaiService.ts       # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AI API
‚îÇ   ‚îî‚îÄ‚îÄ mediaService.ts        # –°–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ –≤ S3
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ models.config.ts       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
‚îî‚îÄ‚îÄ context/
    ‚îú‚îÄ‚îÄ ChatContext.tsx        # –õ–æ–≥–∏–∫–∞ —á–∞—Ç–∞, –º–µ–¥–∏–∞ –∏ WebSocket
    ‚îî‚îÄ‚îÄ SettingsContext.tsx    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

### API Endpoints (Frontend ‚Üí Backend)
- **Base URL**: `http://10.0.2.2:8081/api` (Android Emulator)
- **Chat**: `POST /v1/chat/completions`
- **Models**: `GET /v1/models`

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:
- **Text**: `meta-llama/Llama-3.3-70B-Instruct-Turbo` (DeepInfra)
- **Audio**: `alloy` (OpenAIFM)
- **Image**: `flux` (PollinationsAI)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `API_OPEN_AI` - API –∫–ª—é—á –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ API (—á–µ—Ä–µ–∑ react-native-config)

## Backend (Go)

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Framework**: Fiber v2
- **Language**: Go
- **Port**: 8081
- **Database**: PostgreSQL (GORM)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
server/
‚îú‚îÄ‚îÄ cmd/api/
‚îÇ   ‚îî‚îÄ‚îÄ main.go              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, —Ä–æ—É—Ç–∏–Ω–≥
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_handler.go   # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω/–¥—Ä—É–∑—å—è/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.go           # –ü—Ä–æ–∫—Å–∏ –¥–ª—è AI —á–∞—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dating_handler.go # –ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, AI —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ media_handler.go  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–∑–∞–≥—Ä—É–∑–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ room_handler.go   # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message_handler.go# –°–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–∞–º–º–∞—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.go           # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + Dating –ø—Ä–æ—Ñ–∏–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ media.go          # –ú–æ–¥–µ–ª—å –¥–ª—è —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ room.go           # –ú–æ–¥–µ–ª—å –∫–æ–º–Ω–∞—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ message.go        # –ú–æ–¥–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rag_service.go    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Gemini RAG
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_chat_service.go# –°–µ—Ä–≤–∏—Å –¥–ª—è AI –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ s3_service.go     # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Timeweb S3 (Storage)
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îî‚îÄ‚îÄ database.go       # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îî‚îÄ‚îÄ go.mod
```

### API Endpoints

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- `POST /api/register` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ PostgreSQL
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ Google Gemini RAG Store
  
- `POST /api/login` - –í—Ö–æ–¥ –ø–æ email
  - –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –ø–æ email

#### Chat
- `POST /api/v1/chat/completions` - –ü—Ä–æ–∫—Å–∏ –¥–ª—è AI —á–∞—Ç–∞
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
  - –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ `https://rvlautoai.ru/webhook/v1/chat/completions`
  - –ü–µ—Ä–µ–¥–∞–µ—Ç API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `API_OPEN_AI`

### –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```go
type User struct {
    KarmicName     string  // –ö–∞—Ä–º–∏—á–µ—Å–∫–æ–µ –∏–º—è
    SpiritualName  string  // –î—É—Ö–æ–≤–Ω–æ–µ –∏–º—è
    Email          string  // Email (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
    Gender         string  // –ü–æ–ª
    Country        string  // –°—Ç—Ä–∞–Ω–∞
    City           string  // –ì–æ—Ä–æ–¥
    Identity       string  // –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å
    Diet           string  // –î–∏–µ—Ç–∞
    Madh           string  // –¢—Ä–∞–¥–∏—Ü–∏—è (–º–∞–¥—Ö)
    Mentor         string  // –ù–∞—Å—Ç–∞–≤–Ω–∏–∫
    Dob            string  // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
    // –ü–æ–ª—è –¥–ª—è –∑–Ω–∞–∫–æ–º—Å—Ç–≤ (Dating)
    Bio            string  // –û —Å–µ–±–µ
    Interests      string  // –ò–Ω—Ç–µ—Ä–µ—Å—ã
    LookingFor     string  // –ö–æ–≥–æ –∏—â—É
    MaritalStatus  string  // –°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
    BirthTime      string  // –í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è
    BirthPlaceLink string  // –ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ)
    DatingEnabled  bool    // –í–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤
    RagFileID      string  // ID —Ñ–∞–π–ª–∞ –≤ RAG —Å–∏—Å—Ç–µ–º–µ
}

type Media struct {
    UserID    uint
    URL       string  // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ S3 URL)
    IsProfile bool    // –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–æ—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–º –∞–≤–∞—Ç–∞—Ä–æ–º
}
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `DB_HOST` - –•–æ—Å—Ç –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: localhost)
- `DB_PORT` - –ü–æ—Ä—Ç –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5435)
- `DB_USER` - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: raguser)
- `DB_PASSWORD` - –ü–∞—Ä–æ–ª—å –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ragpassword)
- `DB_NAME` - –ò–º—è –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ragdb)
- `API_OPEN_AI` - API –∫–ª—é—á –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ AI API

#### S3 (Timeweb Cloud)
- `S3_ENDPOINT` - URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://s3.twcstorage.ru)
- `S3_REGION` - –†–µ–≥–∏–æ–Ω (ru-1)
- `S3_ACCESS_KEY` - –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ S3
- `S3_SECRET_KEY` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á S3
- `S3_BUCKET_NAME` - –ò–º—è –±–∞–∫–µ—Ç–∞
- `S3_PUBLIC_URL` - –ü—É–±–ª–∏—á–Ω—ã–π URL –±–∞–∫–µ—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **Image**: postgres:15-alpine
- **Port**: 5435 (host) ‚Üí 5432 (container)
- **Database**: ragdb
- **User**: raguser
- **Password**: ragpassword

### –ú–∏–≥—Ä–∞—Ü–∏–∏
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ GORM –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞.

## RAG Integration (Google Gemini)

### –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
1. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
2. **Upload File** - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Google Gemini —á–µ—Ä–µ–∑ `upload/v1beta/files`
3. **Import to Store** - –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ –≤ RAG Store —á–µ—Ä–µ–∑ `fileSearchStores/{storeId}:importFile`

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **API Key**: –•–∞—Ä–¥–∫–æ–¥ –≤ `rag_service.go` (TODO: –≤—ã–Ω–µ—Å—Ç–∏ –≤ env)
- **Store ID**: `my-store-tva5a8g0mgj3` (TODO: —Å–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º)
- **Upload URL**: `https://generativelanguage.googleapis.com/upload/v1beta/files`
- **Import URL**: `https://generativelanguage.googleapis.com/v1beta/fileSearchStores/{storeId}:importFile`

## Proxy Server (Node.js)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Roo Code Nightly –ø–ª–∞–≥–∏–Ω–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–±–∏–ª—å–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º).

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **Port**: 3001
- **Target**: `https://rvlautoai.ru/webhook`
- **Default Provider**: Capi

### –§—É–Ω–∫—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `provider` –≤ –∑–∞–ø—Ä–æ—Å—ã
- –ú–∞–ø–ø–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤

## Docker Compose

### –°–µ—Ä–≤–∏—Å—ã
1. **postgres** - PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
2. **server** - Go –±–µ–∫–µ–Ω–¥ —Å–µ—Ä–≤–µ—Ä

### –ü–æ—Ä—Ç—ã
- PostgreSQL: 5435 (host) ‚Üí 5432 (container)
- Server: 8082 (host) ‚Üí 8080 (container)

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
Frontend (RegistrationScreen)
  ‚Üí POST /api/register
    ‚Üí Go Backend (auth_handler.go)
      ‚Üí PostgreSQL (save initial user)
      ‚Üí Google Gemini RAG (rag_service.go)
        ‚Üí Upload Profile (native Go HTTP request)
        ‚Üí Import to Store (native Go HTTP request)
        ‚Üí Return RagFileID
      ‚Üí PostgreSQL (update user with RagFileID)
```

### –ß–∞—Ç —Å AI
```
Frontend (App.tsx)
  ‚Üí sendMessage() (openaiService.ts)
    ‚Üí POST http://10.0.2.2:8081/api/v1/chat/completions
      ‚Üí Go Backend (chat.go)
        ‚Üí POST https://rvlautoai.ru/webhook/v1/chat/completions
          ‚Üí External API (RVFreeLLM)
            ‚Üí Response
              ‚Üí Go Backend (–ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ)
                ‚Üí Frontend (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞)
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏ (Communities)
```
Frontend (PortalChatScreen)
  ‚Üí GET /api/v1/rooms
    ‚Üí Go Backend (rooms_handler.go)
      ‚Üí PostgreSQL (fetch rooms/communities)
        ‚Üí Frontend (—Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤)
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### Android Emulator Networking
- `10.0.2.2` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π IP –∞–¥—Ä–µ—Å Android —ç–º—É–ª—è—Ç–æ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ localhost —Ö–æ—Å—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∫ –±–µ–∫–µ–Ω–¥—É –Ω–∞ —Ö–æ—Å—Ç–µ

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ RAG
- –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –≤ RAG –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (goroutine)
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ RAG –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- –û—à–∏–±–∫–∏ RAG –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- Go –±–µ–∫–µ–Ω–¥ –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–∞–∫ –ø—Ä–æ–∫—Å–∏ –º–µ–∂–¥—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –∏ –≤–Ω–µ—à–Ω–∏–º API
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫—Ä—ã—Ç—å API –∫–ª—é—á –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### Backend
```bash
cd server
go run cmd/api/main.go
```

### Frontend
```bash
cd frontend
pnpm start
```

### Docker Compose
```bash
docker-compose up -d
```

### –ü–æ–ª–Ω—ã–π –∑–∞–ø—É—Å–∫ (–∏–∑ –∫–æ—Ä–Ω—è)
```bash
pnpm run dev  # Backend + Frontend –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```

## API Documentation (Unlimited-LLMs / RVFreeLLM)

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω–∏–π API-—à–ª—é–∑ **RVFreeLLM** (Unlimited-LLMs) –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏. –í –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ—Ç API —Ç–∞–∫–∂–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `API_OPEN_AI`.

### –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- **Base URL**: `https://rvlautoai.ru/webhook`
- **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**: JSON (`Content-Type: application/json`)
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: OpenAI API Compatible (—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏)

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –º–µ—Ç–æ–¥–∞–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization`.

- **–§–æ—Ä–º–∞—Ç**: `Authorization: Bearer YOUR_API_KEY`
- **–ö–ª—é—á –ø—Ä–æ–µ–∫—Ç–∞**: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `API_OPEN_AI` (–ø—Ä–µ—Ñ–∏–∫—Å `rvf_`, –¥–ª–∏–Ω–∞ 75 —Å–∏–º–≤–æ–ª–æ–≤)

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–π–Ω—Ç—ã

#### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ —á–∞—Ç
- **–ú–µ—Ç–æ–¥**: `POST /v1/chat/completions`
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**:
  - `model`: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gpt-4o`, `meta-llama/Llama-3.3-70B-Instruct-Turbo`)
  - `provider`: –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–¥–µ–ª–∏ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, `Capi`, `DeepInfra`)
  - `messages`: –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAI (`role`, `content`)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ (Go Proxy):**
–ë—ç–∫–µ–Ω–¥ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—è –∫–ª—é—á `API_OPEN_AI` –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

```json
{
  "model": "gpt-4o",
  "provider": "Capi",
  "messages": [
    {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç, —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ"}
  ],
  "stream": false
}
```

#### 2. –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- **–ú–µ—Ç–æ–¥**: `GET /v1/models`
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–ø—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥)
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, –∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞.

### –¢–∏–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π
| –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ |
|-----|------------|------------------|
| `text` | –ß–∞—Ç –∏ —Ç–µ–∫—Å—Ç | `Llama-3.3-70B`, `gpt-4o` |
| `image` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | `flux`, `dall-e-3` |
| `audio` | TTS –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è | `alloy`, `whisper` |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ø—Ä–æ–µ–∫—Ç–∞
1. **–ú–∞–ø–ø–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π**: –í `frontend/config/models.config.ts` —Å–ª–µ–¥—É–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∏–º—è –º–æ–¥–µ–ª–∏, –Ω–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
2. **Fallback**: API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback. –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é (–ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Unlimited-LLMs).
3. **–õ–æ–∫–∞–ª—å–Ω—ã–π Proxy**: –í –ø—Ä–æ–µ–∫—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π Proxy-—Å–µ—Ä–≤–µ—Ä (Node.js –Ω–∞ –ø–æ—Ä—Ç—É 3001), –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

## TODO / –£–ª—É—á—à–µ–Ω–∏—è

1. **RAG Service**:
   - –í—ã–Ω–µ—Å—Ç–∏ API –∫–ª—é—á Google Gemini –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –°–¥–µ–ª–∞—Ç—å Store ID –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–º
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫—É

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –î–æ–±–∞–≤–∏—Ç—å JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - Rate limiting

3. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —á–∞—Ç–µ (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤)
   - –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —á–∞—Ç–µ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏ –∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏ (–∑–∞–º–µ–Ω–∞ –º–æ–∫–æ–≤ –≤ `PortalChatScreen.tsx`)

5. **–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –∏–¥–µ–∏ (Social & Community)**:
   - **üì¢ –ö–∞–Ω–∞–ª—ã –≤–µ—â–∞–Ω–∏—è**: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç "—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è" –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –∞–Ω–æ–Ω—Å–æ–≤.
   - **üìç –ì–µ–æ-—á–∞—Ç—ã**: –ü–æ–∏—Å–∫ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
   - **ü§ñ AI-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ AI –≤ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã –¥–ª—è –ø–æ–º–æ—â–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
   - **üìä –û–ø—Ä–æ—Å—ã (Polls)**: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤.

4. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏)
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
   - CI/CD pipeline

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å RAG (API Restrictions)

### 1. –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Google
Google Gemini API (–æ—Å–æ–±–µ–Ω–Ω–æ Semantic Retrieval / Corpora) –∏–º–µ–µ—Ç –∂–µ—Å—Ç–∫–∏–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º —Ä–µ–≥–∏–æ–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –†–§), –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ Go-–±—ç–∫–µ–Ω–¥–∞ –∫ `generativelanguage.googleapis.com` –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É `400 Bad Request: User location is not supported`.

### 2. –°–ø–æ—Å–æ–±—ã —Ä–µ—à–µ–Ω–∏—è
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VDS –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º —Ä–µ–≥–∏–æ–Ω–µ**: –ë—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –°–®–ê –∏–ª–∏ –ï–≤—Ä–æ–ø–µ), –≥–¥–µ API –¥–æ—Å—Ç—É–ø–Ω–æ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP-–ø—Ä–æ–∫—Å–∏**: –í `rag_service.go` –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `PROXY_URL` –≤ `.env`, —á—Ç–æ–±—ã –∑–∞–ø—Ä–æ—Å—ã –∫ Google —à–ª–∏ —á–µ—Ä–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π IP.
*   **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Corpus**: –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (Corpus) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ —á–µ—Ä–µ–∑ VPN –∏–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–ø–∏—Å—ã–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π `GEMINI_CORPUS_ID` –≤ –∫–æ–Ω—Ñ–∏–≥.

### 3. –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (File API)
–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞ —Å `corpora` –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏–∑-–∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ **Gemini File API**. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–¥–µ–ª–∏ (`generateContent`) –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ, —á—Ç–æ –º–µ–Ω–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø—Ä–æ–≤–µ—Ä–∫–∞–º –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–∏—Å–∫–∞.

## Gemini API Integration (Chat)

### –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç Google Gemini API –¥–ª—è —á–∞—Ç–∞ —Å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–º, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–º –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ fallback

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        GEMINI FALLBACK CHAIN                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ   gemini-2.5-flash + Key 1                                         ‚îÇ
‚îÇ         ‚Üì (429/error)                                               ‚îÇ
‚îÇ   gemini-2.5-flash + Key 2                                         ‚îÇ
‚îÇ         ‚Üì (429/error)                                               ‚îÇ
‚îÇ   gemini-2.5-flash + Key 3                                         ‚îÇ
‚îÇ         ‚Üì (all keys exhausted)                                      ‚îÇ
‚îÇ   gemini-2.5-flash-lite + Key 1                                    ‚îÇ
‚îÇ         ‚Üì (429/error)                                               ‚îÇ
‚îÇ   gemini-2.5-flash-lite + Key 2                                    ‚îÇ
‚îÇ         ‚Üì (429/error)                                               ‚îÇ
‚îÇ   gemini-2.5-flash-lite + Key 3                                    ‚îÇ
‚îÇ         ‚Üì (all Gemini exhausted)                                    ‚îÇ
‚îÇ   OpenAI (RVFreeLLM proxy)                                         ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. GeminiService (`server/internal/services/gemini_service.go`)
- **–†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É 3 API –∫–ª—é—á–∞–º–∏
- **Fallback –º–æ–¥–µ–ª–µ–π**: –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ gemini-2.5-flash ‚Üí gemini-2.5-flash-lite
- **–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-goog-api-key` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è**: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç OpenAI-—Ñ–æ—Ä–º–∞—Ç –≤ Gemini-—Ñ–æ—Ä–º–∞—Ç –∏ –æ–±—Ä–∞—Ç–Ω–æ

#### 2. Cloudflare Worker Proxy (`GEMINI_BASE_URL`)
- **URL**: `https://mute-waterfall-ef1e.makstreid.workers.dev`
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `generativelanguage.googleapis.com` –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ü–µ—Ä–µ–¥–∞—á–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-goog-api-key`
  - CORS –æ–±—Ä–∞–±–æ—Ç–∫–∞
  - –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–ø–∞—Ä–∞–º–µ—Ç—Ä `?url=`)

#### 3. AutoMagic Routing (`server/internal/handlers/chat.go`)
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: Gemini –º–æ–¥–µ–ª–∏ (provider=Google) –∏–º–µ—é—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- **Fallback**: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö Gemini –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ OpenAI

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Primary Gemini key (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º)
GEMINI_API_KEY=

# Backup keys (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback)
GEMINI_API_KEY_BACKUP_1=
GEMINI_API_KEY_BACKUP_2=

# Proxy URL (Cloudflare Worker)
GEMINI_BASE_URL=
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏ (2025)

| –ú–æ–¥–µ–ª—å | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|----------|
| `gemini-2.5-flash` | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –º–æ–¥–µ–ª—å, –≤—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å |
| `gemini-2.5-flash-lite` | ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ | –õ—ë–≥–∫–∞—è –≤–µ—Ä—Å–∏—è, fallback –º–æ–¥–µ–ª—å |
| `gemini-2.0-flash` | ‚ö†Ô∏è –õ–∏–º–∏—Ç—ã | –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å—á–µ—Ä–ø–∞–Ω–∞ –Ω–∞ Free Tier |
| `gemini-3-*` | ‚ùå Preview | –ï—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ API |

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Seed –º–æ–¥–µ–ª–µ–π

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ (`SeedGeminiModels()` –≤ `database/seed.go`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –º–æ–¥–µ–ª–∏ Gemini –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º AutoRouting.

### Cloudflare Worker Code

```javascript
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 1. CORS Preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-goog-api-key',
        },
      });
    }

    // 2. Image Proxy (with User-Agent to avoid 403)
    const proxyUrl = url.searchParams.get('url');
    if (proxyUrl) {
      try {
        const imageResponse = await fetch(proxyUrl, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }
        });
        
        const newHeaders = new Headers();
        newHeaders.set('Access-Control-Allow-Origin', '*');
        newHeaders.set('Content-Type', imageResponse.headers.get('Content-Type') || 'image/webp');
        
        return new Response(imageResponse.body, {
          status: imageResponse.status,
          headers: newHeaders
        });
      } catch (e) {
        return new Response('Proxy Error: ' + e.message, { status: 500 });
      }
    }
    
    // 3. Gemini API Proxy  
    if (url.pathname.startsWith('/v1beta/')) {
        url.hostname = 'generativelanguage.googleapis.com';
        
        const headers = new Headers(request.headers);
        headers.set('Content-Type', 'application/json');
        const apiKey = request.headers.get('X-goog-api-key');
        if (apiKey) headers.set('X-goog-api-key', apiKey);

        const body = request.method === 'POST' ? await request.text() : null;
        const response = await fetch(url.toString(), {
          method: request.method,
          headers: headers,
          body: body,
        });

        const respHeaders = new Headers(response.headers);
        respHeaders.set('Access-Control-Allow-Origin', '*');

        return new Response(await response.blob(), {
          status: response.status,
          headers: respHeaders,
        });
    }
    
    return new Response('Not Found', { status: 404 });
  },
};
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É Gemini:

```
[Gemini] Attempting direct Gemini API for model: gemini-2.5-flash
[GeminiService] Success with model gemini-2.5-flash, key index 0
[Gemini] All Gemini keys failed for gemini-2.5-flash: ... Falling back to OpenAI proxy.
```

### –ê–¥–º–∏–Ω–∫–∞

- **Settings ‚Üí AI & API**: –ü–æ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è 3 Gemini –∫–ª—é—á–∞–º–∏
- **AI Models**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ Gemini –º–æ–¥–µ–ª–µ–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è

## –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ø–Ω–≤–∞—Ä—å 2026)

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ S3 (Timeweb Cloud)
*   **–û—à–∏–±–∫–∞**: `SignatureDoesNotMatch` (403 Forbidden). –ù–∞–±–ª—é–¥–∞–ª–∞—Å—å –∏–∑-–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π –æ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ Swift –≤–º–µ—Å—Ç–æ S3.
*   **–†–µ—à–µ–Ω–∏–µ**: –í —Ñ–∞–π–ª–µ `.env` –±—ç–∫–µ–Ω–¥–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω `S3_SECRET_KEY`.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ–±–ª–∞–∫–æ Timeweb.

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤ –≤ React (Duplicate Keys)
*   **–û—à–∏–±–∫–∞**: `Encountered two children with the same key`. –í–æ–∑–Ω–∏–∫–∞–ª–∞ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ID –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î (ID `3`).
*   **–†–µ—à–µ–Ω–∏–µ**:
    *   –í–Ω–µ–¥—Ä–µ–Ω—ã –ø—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö ID: `ai_`, `user_`, `sys_`, `welcome_`.
    *   –í `ChatContext.tsx` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ WebSocket –∏ HTTP response.

### 3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö (Rooms)
*   **–ü—Ä–æ–±–ª–µ–º–∞**: –í `RoomChatScreen.tsx` —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∫–∞–∫ —Ç–µ–∫—Å—Ç (URL —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã).
*   **–†–µ—à–µ–Ω–∏–µ**:
    *   –û–±–Ω–æ–≤–ª–µ–Ω –º–∞–ø–ø–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `ChatContext` –∏ `RoomChatScreen` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª—è `type`.
    *   –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ `AudioPlayer`, `Image` –∏ `Document` –≤ —Å–ø–∏—Å–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä—É–º–∞.
    *   –¢–µ–ø–µ—Ä—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∫–æ–º–Ω–∞—Ç.

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ React Native Release Build (–Ø–Ω–≤–∞—Ä—å 2026)
*   **–ü—Ä–æ–±–ª–µ–º–∞**: APK —Å–æ–±–∏—Ä–∞–ª—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–ª–æ—Å—å (crash).
*   **–û—à–∏–±–∫–∏**:
    *   `com.facebook.soloader.B: couldn't find DSO to load: libreanimated.so`
    *   `Missing class com.facebook.proguard.annotations.DoNotStrip` –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ ProGuard
*   **–ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
    1. **–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ABI**: `reactNativeArchitectures` –≤ `gradle.properties` –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ `armeabi-v7a` (32-bit)
    2. **–û—Ç–∫–ª—é—á–µ–Ω ProGuard**: `enableProguardInReleaseBuilds = false` –≤ `app/build.gradle`
    3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ ProGuard –ø—Ä–∞–≤–∏–ª**: Missing keep rules –¥–ª—è React Native –∫–ª–∞—Å—Å–æ–≤
*   **–†–µ—à–µ–Ω–∏–µ**:
    1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ ABI –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä** (`frontend/android/gradle.properties:34`):
        ```gradle
        reactNativeArchitectures=arm64-v8a,x86_64  # –ë—ã–ª–æ: armeabi-v7a
        ```
    2. **–í–∫–ª—é—á–µ–Ω–∏–µ ProGuard** (`frontend/android/app/build.gradle:8`):
        ```gradle
        def enableProguardInReleaseBuilds = true  # –ë—ã–ª–æ: false
        ```
    3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ProGuard –ø—Ä–∞–≤–∏–ª** (`frontend/android/app/proguard-rules.pro`):
        ```proguard
        -keep class com.facebook.react.** { *; }
        -dontwarn com.facebook.react.**
        -dontwarn com.facebook.proguard.annotations.**
        -keep class com.facebook.proguard.annotations.** { *; }
        -keep class com.facebook.hermes.** { *; }
        -keep class com.facebook.jsi.** { *; }
        ```
    4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ABI —Ñ–∏–ª—å—Ç—Ä–æ–≤** (`frontend/android/app/build.gradle:80-82`):
        ```gradle
        ndk {
            abiFilters 'arm64-v8a', 'x86_64'  # –ë—ã–ª–æ: 'armeabi-v7a', 'arm64-v8a'
        }
        ```
    5. **–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ codegenConfig** –∏–∑ `package.json` (–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å React Native 0.76.5)
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç**:
    *   APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è (30 MB)
    *   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    *   Google Play –ø—Ä–∏–Ω–∏–º–∞–µ—Ç APK (64-bit —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
*   **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏**:
    *   –î–æ–±–∞–≤–ª–µ–Ω `resolutionStrategy` –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    *   –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã `packagingOptions` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —É–ø–∞–∫–æ–≤–∫–∏ .so —Ñ–∞–π–ª–æ–≤
    *   –ò—Å–∫–ª—é—á–µ–Ω `com.facebook.yoga:proguard-annotations` (–ø–∞–¥–∞–µ—Ç –∏–∑ react-native 0.76)

–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
–í–ö–æ–Ω—Ç–∞–∫—Ç–µ
–¥–ª—è –ø—Ä–æ–¥–∂–µ–∫—Ç –≤–µ—Å—Ä–∏–∏
<div>
  <script nonce="csp_nonce" src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
  <script nonce="csp_nonce" type="text/javascript">
    if ('VKIDSDK' in window) {
      const VKID = window.VKIDSDK;

      VKID.Config.init({
        app: 54418465,
        redirectUrl: 'https://api.vedamatch.ru/auth/vk/callback',
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: '', // –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω—É–∂–Ω—ã–º–∏ –¥–æ—Å—Ç—É–ø–∞–º–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      });

      const oneTap = new VKID.OneTap();

      oneTap.render({
        container: document.currentScript.parentElement,
        showAlternativeLogin: true
      })
      .on(VKID.WidgetEvents.ERROR, vkidOnError)
      .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
        const code = payload.code;
        const deviceId = payload.device_id;

        VKID.Auth.exchangeCode(code, deviceId)
          .then(vkidOnSuccess)
          .catch(vkidOnError);
      });
    
      function vkidOnSuccess(data) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      }
    
      function vkidOnError(error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
      }
    }
  </script>
</div>
–¥–ª—è DEV –≤–µ—Ä—Å–∏–∏ 

<div>
  <script nonce="csp_nonce" src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
  <script nonce="csp_nonce" type="text/javascript">
    if ('VKIDSDK' in window) {
      const VKID = window.VKIDSDK;

      VKID.Config.init({
        app: 54418465,
        redirectUrl: 'http://localhost',
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: '', // –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω—É–∂–Ω—ã–º–∏ –¥–æ—Å—Ç—É–ø–∞–º–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      });

      const floatingOneTap = new VKID.FloatingOneTap();

      floatingOneTap.render({
        appName: 'VedamatchAI',
        showAlternativeLogin: true
      })
      .on(VKID.WidgetEvents.ERROR, vkidOnError)
      .on(VKID.FloatingOneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
        const code = payload.code;
        const deviceId = payload.device_id;

        VKID.Auth.exchangeCode(code, deviceId)
          .then(vkidOnSuccess)
          .catch(vkidOnError);
      });
    
      function vkidOnSuccess(data) {
        floatingOneTap.close();
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      }
    
      function vkidOnError(error) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
      }
    }
  </script>
</div>

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ WebRTC –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ (–Ø–Ω–≤–∞—Ä—å 2026)

–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ –≤ Rag Agent –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –±–∞–∑–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ WebRTC –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç P2P —Å–≤—è–∑—å –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ–±—Ö–æ–¥–æ–º NAT —á–µ—Ä–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π TURN-—Å–µ—Ä–≤–µ—Ä.

### 1. –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- **–ö–ª–∏–µ–Ω—Ç**: `react-native-webrtc` –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è PeerConnection.
- **–ê—É–¥–∏–æ**: `react-native-incall-manager` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞–º–∏ –¥–∏–Ω–∞–º–∏–∫–∞/–≥–∞—Ä–Ω–∏—Ç—É—Ä—ã.
- **–°–∏–≥–Ω–∞–ª–∏–Ω–≥**: WebSocket (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Hub –≤ Go backend).
- **Relay**: Coturn (STUN/TURN —Å–µ—Ä–≤–µ—Ä) –¥–ª—è –ø—Ä–æ–±–∏–≤–∫–∏ NAT.
- **Backend**: Go (Fiber) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö TURN (REST API).

### 2. –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Caller     ‚îÇ          ‚îÇ   Backend    ‚îÇ          ‚îÇ   Callee     ‚îÇ
‚îÇ (App/React)  ‚îÇ          ‚îÇ (Go/Socket)  ‚îÇ          ‚îÇ (App/React)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                         ‚îÇ                         ‚îÇ
       ‚îÇ 1. Get TURN Credentials ‚îÇ                         ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
       ‚îÇ <‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ                         ‚îÇ
       ‚îÇ                         ‚îÇ                         ‚îÇ
       ‚îÇ 2. Send OFFER (WS)      ‚îÇ                         ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
       ‚îÇ                         ‚îÇ 3. Forward OFFER (WS)   ‚îÇ
       ‚îÇ                         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                         ‚îÇ                         ‚îÇ
       ‚îÇ                         ‚îÇ 4. ACCEPT & Create Ans. ‚îÇ
       ‚îÇ                         ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ 5. Forward ANSWER (WS)  ‚îÇ                         ‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                         ‚îÇ
       ‚îÇ                         ‚îÇ                         ‚îÇ
       ‚îÇ 6. Exchange ICE Cand.   ‚îÇ                         ‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                         ‚îÇ                         ‚îÇ
       ‚îÇ         7. P2P Direct Media (UDP)                 ‚îÇ
       ‚îÇ<‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê>‚îÇ
       ‚îÇ         (or via TURN: 45.150.9.229)               ‚îÇ
```

### 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### A. Signaling (WebSocket Hub)
–ü–µ—Ä–µ–¥–∞–µ—Ç JSON-—Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∑–≤–æ–Ω–∫–∞:
- `offer`: –°–æ–¥–µ—Ä–∂–∏—Ç SDP –æ—Ñ—Ñ–µ—Ä–∞.
- `answer`: –°–æ–¥–µ—Ä–∂–∏—Ç SDP –æ—Ç–≤–µ—Ç–∞.
- `candidate`: ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ —Å–≤—è–∑–∏.
- `hangup`: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—ã–∑–æ–≤–∞.

#### B. TURN Server (Coturn)
- **IP**: `45.150.9.229` (–ü–æ—Ä—Ç 3478 UDP/TCP).
- **AUTH**: REST API Auth (Time-limited credentials). 
- **Secret**: –ó–∞–¥–∞–Ω –≤ `.env` (–±—ç–∫–µ–Ω–¥) –∏ `docker-compose.prod.yml`.
- **–†–µ–∂–∏–º**: `network_mode: host` –≤ Docker –¥–ª—è –ø—Ä—è–º–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ä—Ç–∞–º–∏ 49152-49162.

#### C. Backend Logic (`server/internal/handlers/turn_handler.go`)
–†–µ–∞–ª–∏–∑—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é HMAC-SHA1 –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –§–æ—Ä–º–∞—Ç Username: `timestamp:userID`
- –ü–∞—Ä–æ–ª—å: HMAC-SHA1 –æ—Ç Username —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `TURN_SECRET`.

#### D. Client Logic (`webRTCService.ts`)
- **Multi-STUN Strategy**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∏–∑ Google –∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (Sipnet, Chathelp, Comtube) –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.
- **Track Handling**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —Ç—Ä–µ–∫–æ–≤ –≤ –æ–¥–∏–Ω `MediaStream`.
- **Race Condition Prevention**: –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `RemoteDescription`.

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –†–§
–í —Å–≤—è–∑–∏ —Å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é Google STUN (stun.l.google.com), –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ICE –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —É–∑–ª—ã:
- `stun:stun.sipnet.ru:3478`
- `stun:stun.chathelp.ru:3478`
- `stun:stun.comtube.ru:3478`

### 5. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker (Coturn)
```yaml
  coturn:
    image: coturn/coturn
    network_mode: host
    environment:
      - EXTERNAL_IP=45.150.9.229
      - LISTENING_PORT=3478
      - MIN_PORT=49152
      - MAX_PORT=49162
      - STATIC_AUTH_SECRET=${TURN_SECRET}
      - REALM=vedamatch.ru
```

## –°–µ—Ä–≤–∏—Å –ö–∞—Ä—Ç (Map Service)

–í —è–Ω–≤–∞—Ä–µ 2026 –≥–æ–¥–∞ –≤ –ø—Ä–æ–µ–∫—Ç –±—ã–ª –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å –∫–∞—Ä—Ç –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∑–∞–º–µ–Ω–∏–≤—à–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Google Maps. –≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–µ–Ω–¥–æ—Ä–∞, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å web-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏ –∏ –≥–∏–±–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.

### 1. –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

- **Frontend (Map View)**: `react-native-webview` + Leaflet.js
- **Map Provider**: Geoapify (Tile Layer, Autocomplete, Reverse Geocoding)
- **Backend Proxy**: Go (Fiber) –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Geoapify API
- **Map Library**: Leaflet.js 1.9.4 (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ CDN)
- **Clustering**: Leaflet.markercluster (–¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤)

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       HTTPS       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       HTTPS       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ React Native    ‚îÇ <‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ    Go Backend   ‚îÇ <‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Geoapify API   ‚îÇ
‚îÇ (WebView)       ‚îÇ    API Proxy      ‚îÇ (map_handler.go)‚îÇ    API Key        ‚îÇ (Maps/Search)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                     ‚îÇ
         ‚îÇ JS Injection (postMessage)          ‚îÇ
         ‚ñº                                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ Leaflet Map     ‚îÇ                            ‚îÇ
‚îÇ (HTML/CS/JS)    ‚îÇ                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
                                               ‚îÇ
                                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                      ‚îÇ   PostgreSQL    ‚îÇ
                                      ‚îÇ (Marker Data)   ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### A. Frontend (`frontend/screens/portal/map/MapGeoapifyScreen.tsx`)
- **WebView**: –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç HTML-–∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç—ã.
- **–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–≤—è–∑—å**:
    - **App -> Map**: `injectJavaScript()` (—Å–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞).
    - **Map -> App**: `onMessage()` (–∫–ª–∏–∫–∏ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç—ã map bounds).
- **–ü–æ–∏—Å–∫**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π `TextInput` –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è (`map.setView`) –∏ —Å—Ç–∞–≤–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä.

#### B. Backend Proxy (`server/internal/handlers/map_handler.go`)
Backend –≤—ã—Å—Ç—É–ø–∞–µ—Ç —à–ª—é–∑–æ–º –¥–ª—è –≤—Å–µ—Ö –≥–µ–æ-–∑–∞–ø—Ä–æ—Å–æ–≤, —Å–∫—Ä—ã–≤–∞—è API –∫–ª—é—á Geoapify –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.

- `GET /api/map/config`: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL —Ç–∞–π–ª–æ–≤ –∏ –∞—Ç—Ä–∏–±—É—Ü–∏—é.
- `GET /api/map/summary`: –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏).
- `GET /api/map/markers`: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä–∫–µ—Ä–∞—Ö –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (viewport).
- `GET /api/map/autocomplete`: –ü—Ä–æ–∫—Å–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤ (Geoapify Autocomplete API).

#### C. Geoapify Integration (`server/internal/services/map_service.go`)
- **Tiles**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∏–ª—å `osm-bright` (–∏–ª–∏ `osm-carto` –∫–∞–∫ fallback).
- **Autocomplete**: –ü–æ–∏—Å–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `bias=proximity` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä—è–¥–æ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º).
- **Geocoding**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### 4. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

*   **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è**: –í—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (Leaflet) –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –¶–≤–µ—Ç–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–µ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Users=–§–∏–æ–ª–µ—Ç–æ–≤—ã–π, Shops=–ó–µ–ª–µ–Ω—ã–π, Ads=–ö—Ä–∞—Å–Ω—ã–π).
*   **Search UX**:
    *   –ü–æ–∏—Å–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞—Ç–∏–≤–Ω–æ ("–Ω–∞–¥ –∫–∞—Ä—Ç–æ–π").
    *   –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–¥—Ä–µ—Å–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π –º–∞—Ä–∫–µ—Ä.
    *   –ö–ª–∏–∫ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –∫–∞—Ä—Ç—ã –æ—á–∏—â–∞–µ—Ç –ø–æ–∏—Å–∫.
*   **–û—Ñ—Ñ–ª–∞–π–Ω-—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∫–µ—à–∏—Ä—É–µ—Ç—Å—è, –Ω–æ —Ç–∞–π–ª—ã —Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

### 5. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Backend)
- `MAP_GEOAPIFY_KEY`: API –∫–ª—é—á –æ—Ç Geoapify Project.
- `MAP_STYLE`: –°—Ç–∏–ª—å –∫–∞—Ä—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `osm-bright`).